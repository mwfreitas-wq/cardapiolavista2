<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Room Service - La Vista</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                fontFamily: { 'sans': ['Roboto'], 'display': ['Oswald'] },
                extend: { colors: { brand: { dark: '#121212', card: '#1e1e1e', accent: '#facc15', muted: '#a3a3a3' } } }
            }
        }
    </script>
    <style>
        body { background-color: #121212; color: #e5e5e5; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        img.error-image { content: url('https://placehold.co/300x200/333/999?text=Sem+Foto'); }
    </style>
</head>
<body class="antialiased pb-24">

    <div class="fixed bottom-4 right-4 z-50 opacity-30 hover:opacity-100 transition">
        <button onclick="toggleAdmin()" class="bg-brand-card border border-brand-accent/30 text-brand-accent px-3 py-1 rounded-full text-xs font-bold shadow-lg">
            <i class="fas fa-lock text-[10px] mr-1"></i> Admin
        </button>
    </div>

    <div id="guest-view">
        <header class="bg-brand-dark border-b-2 border-brand-accent shadow-2xl sticky top-0 z-40">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="h-12 w-12 bg-brand-accent rounded-xl flex items-center justify-center shadow-lg -rotate-3">
                        <i class="fas fa-concierge-bell text-brand-dark text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="font-display font-bold text-2xl text-white tracking-wide leading-none">LA VISTA</h1>
                        <p class="text-brand-accent text-sm font-medium tracking-wider" id="header-subtitle">ROOM SERVICE</p>
                    </div>
                </div>
                <button onclick="openCart()" class="relative bg-brand-card p-3 rounded-xl text-brand-accent shadow-xl border border-brand-accent/20">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold h-5 w-5 flex items-center justify-center rounded-full hidden">0</span>
                </button>
            </div>
        </header>
        <main class="container mx-auto px-3 py-6 max-w-2xl" id="menu-container"></main>
    </div>

    <div id="cart-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-md flex items-end sm:items-center justify-center">
        <div class="bg-brand-dark w-full max-w-md h-[95vh] sm:h-auto sm:rounded-2xl rounded-t-3xl shadow-2xl border-t-2 border-brand-accent flex flex-col fade-in">
            <div class="bg-brand-card p-5 flex justify-between items-center border-b border-white/10">
                <h3 class="font-display font-bold text-xl text-white tracking-wider">SEU PEDIDO</h3>
                <button onclick="closeCart()" class="text-white hover:text-brand-accent"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3 bg-[#151515]"></div>
            
            <div id="combo-error" class="hidden bg-red-900/50 border-l-4 border-red-500 text-red-200 p-3 text-xs mx-4 mt-2">
                <i class="fas fa-exclamation-triangle mr-1"></i> A batata promocional (R$15) s√≥ √© v√°lida com um hamb√∫rguer.
            </div>

            <div class="p-5 bg-brand-card border-t border-white/10">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-brand-muted">Total:</span>
                    <span id="cart-total" class="font-display font-bold text-3xl text-brand-accent">R$ 0,00</span>
                </div>
                <form id="order-form" onsubmit="event.preventDefault(); sendOrder();" class="space-y-3">
                    
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-2 relative">
                            <i class="fas fa-user absolute left-3 top-3.5 text-brand-muted"></i>
                            <input type="text" id="guest-name" placeholder="Seu Nome" required class="w-full bg-brand-dark border border-white/10 pl-10 p-3 rounded-xl text-white outline-none focus:border-brand-accent">
                        </div>
                        <div class="relative">
                            <input type="number" id="room-number" placeholder="Quarto" required class="w-full bg-brand-dark border border-white/10 p-3 rounded-xl text-white outline-none focus:border-brand-accent text-center">
                        </div>
                    </div>
                    
                    <textarea id="order-notes" placeholder="Observa√ß√µes (ex: sem cebola...)" class="w-full bg-brand-dark border border-white/10 p-3 rounded-xl text-white outline-none focus:border-brand-accent h-16 resize-none"></textarea>
                    
                    <button type="submit" id="btn-checkout" class="w-full bg-brand-accent text-brand-dark font-bold text-lg py-4 rounded-xl shadow-lg hover:bg-yellow-400 transition disabled:opacity-50">
                        CONFIRMAR PEDIDO <i class="fas fa-paper-plane ml-2"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div id="admin-view" class="hidden min-h-screen bg-gray-100 text-gray-800 font-sans">
        <header class="bg-gray-900 text-white p-4 shadow-lg sticky top-0 z-40">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="font-bold text-xl"><i class="fas fa-chart-pie text-brand-accent mr-2"></i>Gest√£o La Vista</h1>
                    <nav class="flex bg-gray-800 rounded p-1 gap-1">
                        <button onclick="switchTab('kds')" id="btn-kds" class="px-4 py-1 rounded bg-brand-accent text-gray-900 font-bold text-sm">Cozinha (KDS)</button>
                        <button onclick="switchTab('dashboard')" id="btn-dash" class="px-4 py-1 rounded text-gray-400 hover:text-white font-bold text-sm">Relat√≥rios</button>
                    </nav>
                </div>
                <button onclick="toggleAdmin()" class="bg-gray-700 px-3 py-1 rounded text-sm hover:bg-red-600">Sair</button>
            </div>
        </header>

        <main class="container mx-auto p-4 max-w-6xl">
            <div id="tab-kds">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700">Fila de Pedidos</h2>
                </div>
                <div id="orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <p class="col-span-full text-center py-20 text-gray-400">Aguardando pedidos...</p>
                </div>
            </div>

            <div id="tab-dashboard" class="hidden space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500">
                        <p class="text-xs font-bold text-gray-400 uppercase">Vendas Hoje</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-total">R$ 0,00</h3>
                        <p class="text-xs text-gray-500 mt-2" id="stat-count">0 pedidos realizados</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-green-500">
                        <p class="text-xs font-bold text-gray-400 uppercase">Ticket M√©dio</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-ticket">R$ 0,00</h3>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-purple-500">
                        <p class="text-xs font-bold text-gray-400 uppercase">Tempo M√©dio</p>
                        <h3 class="text-3xl font-bold text-gray-800 mt-1" id="stat-time">-- min</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">üèÜ Mais Vendidos</h3>
                        <div id="top-products" class="space-y-3"></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">üìä Hist√≥rico de Hoje</h3>
                        <div class="overflow-y-auto h-64 text-sm">
                            <table class="w-full text-left">
                                <thead class="text-gray-400 bg-gray-50 sticky top-0">
                                    <tr><th class="p-2">Hora</th><th class="p-2">Hotel/Quarto</th><th class="p-2">Total</th></tr>
                                </thead>
                                <tbody id="history-table" class="divide-y"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button onclick="loadReports()" class="bg-brand-accent text-brand-dark px-6 py-2 rounded font-bold shadow hover:bg-yellow-400">Atualizar Dados</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCdOqHyZNpPdvZC1RD9_OuSJeBHwPxjovQ",
            authDomain: "cardapio-hit-hotel.firebaseapp.com",
            projectId: "cardapio-hit-hotel",
            storageBucket: "cardapio-hit-hotel.firebasestorage.app",
            messagingSenderId: "107290897891",
            appId: "1:107290897891:web:380ef50a89c27aae1e44d6"
        };

        let db;
        try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); } catch (e) { console.error(e); }

        // --- 2. LEITURA INTELIGENTE DE URL E VARI√ÅVEL DE HOTEL ---
        // Aqui o sistema salva a informa√ß√£o de forma invis√≠vel para enviar junto com o pedido
        let currentHotel = "Hotel N√£o Informado";

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const hotelParam = urlParams.get('hotel');
            
            if (hotelParam === 'hit') {
                currentHotel = 'Hit Hotel';
                document.getElementById('header-subtitle').innerText = 'HIT HOTEL';
            } else if (hotelParam === 'porto') {
                currentHotel = 'Porto Salvador';
                document.getElementById('header-subtitle').innerText = 'PORTO SALVADOR';
            }
            
            renderMenu();
        });

        // --- DADOS DO CARD√ÅPIO ---
        const burgerNames = ["La Vista Burguer", "Brioche 3 Queijos", "Brioche Frango & P√°prica", "Cl√°ssico La Vista", "Frango Fresco"];
        const menuData = [
            { category: "Sandu√≠ches & Burgers", icon: "fa-burger", items: [
                { name: "La Vista Burguer", desc: "P√£o brioche, Crispy de Bacon.", price: 39.90, image: "img/burguer-lavista.jpg" },
                { name: "Brioche 3 Queijos", desc: "Hamb√∫rguer 120g, molho 3 queijos.", price: 34.90, image: "img/burguer-3queijos.jpg" },
                { name: "Combo La Vista", desc: "Adicione Batata Frita ao seu Lanche.", price: 15.00, image: "img/combo.jpg" },
                { name: "Brioche Frango & P√°prica", desc: "Frango, molho 3 queijos.", price: 29.90, image: "img/burguer-frango.jpg" },
                { name: "Cl√°ssico La Vista", desc: "Misto quente artesanal.", price: 15.90, image: "img/misto.jpg" },
                { name: "Frango Fresco", desc: "Natural no Sourdough integral.", price: 24.90, image: "img/natural.jpg" }
            ]},
            { category: "Pizzas (20cm & 30cm)", icon: "fa-pizza-slice", items: [
                { name: "Mussarela (20cm)", desc: "Individual.", price: 30.00, image: "img/pizza-mussarela.jpg" },
                { name: "Mussarela (30cm)", desc: "M√©dia.", price: 55.00, image: "img/pizza-mussarela.jpg" },
                { name: "Calabresa (20cm)", desc: "Individual.", price: 30.00, image: "img/pizza-calabresa.jpg" },
                { name: "Calabresa (30cm)", desc: "M√©dia.", price: 55.00, image: "img/pizza-calabresa.jpg" },
                { name: "Marguerita (20cm)", desc: "Individual.", price: 30.00, image: "img/pizza-marguerita.jpg" },
                { name: "Marguerita (30cm)", desc: "M√©dia.", price: 55.00, image: "img/pizza-marguerita.jpg" }
            ]},
            { category: "Sopas & Massas", icon: "fa-bowl-food", items: [
                { name: "Nhoque Napolitano", desc: "Molho sugo artesanal.", price: 29.90, image: "img/nhoque.jpg" },
                { name: "Creme de Cebola", desc: "Com croutons e torrada.", price: 20.90, image: "img/sopa.jpg" },
                { name: "Batata Frita", desc: "Por√ß√£o 250g.", price: 19.90, image: "img/batata.jpg" }
            ]},
            { category: "Bebidas", icon: "fa-cocktail", items: [
                { name: "Caipirinha", price: 20.00, image: "img/caipirinha.jpg" },
                { name: "Caipifruta", price: 22.00, image: "img/caipifruta.jpg" },
                { name: "Frupiroska", price: 30.00, image: "img/frupiroska.jpg" },
                { name: "Cuba Libre", price: 25.00, image: "img/cuba-libre.jpg" },
                { name: "Heineken 350ml", price: 14.00, image: "img/cerveja.jpg" },
                { name: "√Ågua Mineral", price: 7.00, image: "img/agua.jpg" },
                { name: "Refrigerante", price: 8.00, image: "img/refri.jpg" }
            ]}
        ];

        let cart = [];

        // --- L√ìGICA DO CLIENTE ---
        function renderMenu() {
            const container = document.getElementById('menu-container');
            container.innerHTML = menuData.map((cat, i) => `
                <details class="group mb-4 bg-brand-card rounded-2xl shadow-lg border border-white/5 overflow-hidden open:border-brand-accent/30" ${i<2?'open':''}>
                    <summary class="flex justify-between items-center p-4 cursor-pointer bg-white/5 hover:bg-white/10 select-none">
                        <div class="flex items-center gap-3"><i class="fas ${cat.icon} text-brand-accent text-xl w-8 text-center"></i><h2 class="font-display font-bold text-xl text-white tracking-wide">${cat.category}</h2></div>
                        <i class="fas fa-chevron-down text-brand-muted group-open:rotate-180 transition-transform"></i>
                    </summary>
                    <div class="p-2 grid grid-cols-1 md:grid-cols-2 gap-3 bg-brand-dark/50">
                        ${cat.items.map((item, j) => `
                            <div class="flex bg-brand-card rounded-xl overflow-hidden shadow-md border border-white/5 hover:border-brand-accent/50 h-28">
                                <div class="w-28 h-full bg-gray-800"><img src="${item.image}" onerror="this.classList.add('error-image')" class="w-full h-full object-cover"></div>
                                <div class="flex-1 p-3 flex flex-col justify-between">
                                    <div><h3 class="font-bold text-white text-sm leading-tight">${item.name}</h3>${item.desc?`<p class="text-xs text-brand-muted line-clamp-2 mt-1">${item.desc}</p>`:''}</div>
                                    <div class="flex justify-between items-end"><span class="font-display font-bold text-xl text-brand-accent">${formatMoney(item.price)}</span><button onclick="addToCart(${i},${j})" class="bg-brand-accent text-brand-dark w-8 h-8 rounded-lg flex items-center justify-center hover:bg-yellow-300 shadow"><i class="fas fa-plus"></i></button></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            `).join('');
        }

        function addToCart(c, i) {
            const item = menuData[c].items[i];
            const ex = cart.find(x => x.name === item.name);
            if(ex) ex.qty++; else cart.push({...item, qty:1});
            updateCart();
        }
        function updateCart() {
            const count = cart.reduce((a,b)=>a+b.qty,0);
            document.getElementById('cart-count').innerText = count; 
            document.getElementById('cart-count').classList.toggle('hidden', count === 0);
            validateCombo();
        }
        function openCart() {
            const list = document.getElementById('cart-items');
            list.innerHTML = cart.length ? cart.map((x, i) => `
                <div class="flex items-center bg-brand-card p-3 rounded-xl border border-white/5">
                    <div class="flex-1"><h4 class="font-bold text-white text-sm">${x.name}</h4><div class="text-brand-accent text-xs">${formatMoney(x.price)}</div></div>
                    <div class="flex items-center bg-brand-dark rounded border border-white/10">
                        <button onclick="qty(${i},-1)" class="w-8 h-8 text-brand-muted hover:text-white">-</button><span class="text-white text-sm font-bold">${x.qty}</span><button onclick="qty(${i},1)" class="w-8 h-8 text-brand-muted hover:text-white">+</button>
                    </div>
                </div>`).join('') : '<div class="text-center py-10 text-brand-muted opacity-50"><p>Carrinho vazio</p></div>';
            document.getElementById('cart-total').innerText = formatMoney(cart.reduce((a,b)=>a+(b.price*b.qty),0));
            document.getElementById('cart-modal').classList.remove('hidden');
            validateCombo();
        }
        function qty(i,d) { cart[i].qty+=d; if(cart[i].qty<=0) cart.splice(i,1); openCart(); updateCart(); }
        function closeCart() { document.getElementById('cart-modal').classList.add('hidden'); }

        function validateCombo() {
            const hasCombo = cart.some(i => i.name === "Combo La Vista");
            const hasBurger = cart.some(i => burgerNames.includes(i.name));
            const err = document.getElementById('combo-error');
            const btn = document.getElementById('btn-checkout');
            if(hasCombo && !hasBurger) { err.classList.remove('hidden'); btn.disabled = true; return false; }
            err.classList.add('hidden'); btn.disabled = false; return true;
        }

        function sendOrder() {
            if(!validateCombo()) return;
            const name = document.getElementById('guest-name').value;
            const room = document.getElementById('room-number').value;
            
            if(!name || !room) return alert("Preencha seu Nome e Quarto!");
            if(cart.length===0) return alert("Carrinho vazio!");

            const btn = document.getElementById('btn-checkout');
            btn.innerHTML = 'Enviando...'; btn.disabled = true;

            db.collection("orders").add({
                hotel: currentHotel, // Envia o hotel capturado pela URL invisivelmente
                guest: name, 
                room: room,
                notes: document.getElementById('order-notes').value,
                items: cart,
                total: cart.reduce((a,b)=>a+(b.price*b.qty),0),
                status: 'pending',
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                completedAt: null
            }).then(() => {
                alert("‚úÖ Pedido Enviado!"); cart=[]; updateCart(); closeCart(); 
                document.getElementById('guest-name').value = '';
                document.getElementById('room-number').value = '';
                document.getElementById('order-notes').value = '';
            }).catch(e=>alert(e)).finally(() => { btn.innerHTML = 'CONFIRMAR PEDIDO'; btn.disabled = false; });
        }

        // --- L√ìGICA DO ADMIN ---
        let adminUnsub;

        function toggleAdmin() {
            const a = document.getElementById('admin-view'), g = document.getElementById('guest-view');
            if(a.classList.contains('hidden')) {
                if(prompt("Senha:")!=="master") return alert("Senha incorreta");
                g.classList.add('hidden'); a.classList.remove('hidden'); switchTab('kds');
            } else {
                g.classList.remove('hidden'); a.classList.add('hidden'); if(adminUnsub) adminUnsub();
            }
        }

        function switchTab(tab) {
            document.getElementById('tab-kds').classList.toggle('hidden', tab!=='kds');
            document.getElementById('tab-dashboard').classList.toggle('hidden', tab!=='dashboard');
            const btnKds = document.getElementById('btn-kds'), btnDash = document.getElementById('btn-dash');

            if(tab === 'kds') {
                btnKds.className = "px-4 py-1 rounded bg-brand-accent text-gray-900 font-bold text-sm";
                btnDash.className = "px-4 py-1 rounded text-gray-400 hover:text-white font-bold text-sm";
                startKDS();
            } else {
                btnDash.className = "px-4 py-1 rounded bg-brand-accent text-gray-900 font-bold text-sm";
                btnKds.className = "px-4 py-1 rounded text-gray-400 hover:text-white font-bold text-sm";
                if(adminUnsub) adminUnsub(); loadReports();
            }
        }

        function startKDS() {
            const list = document.getElementById('orders-list');
            adminUnsub = db.collection("orders").where("status", "in", ["pending", "preparing", "ready"])
                .orderBy("timestamp", "asc").onSnapshot(snap => {
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = '<p class="col-span-full text-center text-gray-400 py-10">Tudo limpo!</p>'; return; }
                
                snap.forEach(doc => {
                    const d = doc.data();
                    
                    if (d.status === 'ready' && d.completedAt) {
                        const now = new Date();
                        const diffSeconds = (now - d.completedAt.toDate()) / 1000;
                        if (diffSeconds > 60) return;
                    }

                    let borderClass = 'border-red-500 bg-red-50';
                    if (d.status === 'preparing') borderClass = 'border-yellow-400 bg-yellow-50';
                    if (d.status === 'ready') borderClass = 'border-green-500 bg-green-50 opacity-75';

                    // Cor da etiqueta do Hotel
                    const hotelColor = d.hotel === 'Hit Hotel' ? 'bg-blue-600' : 'bg-orange-600';
                    const time = d.timestamp ? d.timestamp.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--';

                    list.innerHTML += `
                        <div class="p-4 rounded-lg shadow-md border-l-8 ${borderClass} relative fade-in">
                            <div class="absolute top-2 right-2 font-mono text-xs text-gray-500 bg-white px-2 rounded border"><i class="far fa-clock"></i> ${time}</div>
                            
                            <div class="inline-block ${hotelColor} text-white text-[10px] font-bold px-2 py-1 rounded mb-2 uppercase">
                                ${d.hotel || 'Hotel N√£o Informado'}
                            </div>

                            <div class="font-bold text-2xl text-gray-800 mb-1 leading-none">Qto ${d.room}</div>
                            <div class="text-sm text-gray-600 font-bold uppercase mb-3">${d.guest}</div>
                            
                            <ul class="text-sm space-y-2 mb-4">
                                ${d.items.map(i => `<li class="border-b border-gray-200 pb-1 flex justify-between"><span>${i.name}</span> <span class="font-bold">x${i.qty}</span></li>`).join('')}
                            </ul>
                            ${d.notes ? `<div class="bg-red-100 text-red-800 p-2 rounded text-xs font-bold mb-3"><i class="fas fa-comment"></i> ${d.notes}</div>` : ''}
                            <div class="flex gap-2 mt-auto">
                                ${d.status === 'pending' ? `<button onclick="updateStatus('${doc.id}', 'preparing')" class="flex-1 bg-yellow-400 text-yellow-900 py-2 rounded font-bold hover:bg-yellow-500 shadow">PREPARAR</button>` : ''}
                                ${d.status === 'preparing' ? `<button onclick="updateStatus('${doc.id}', 'ready')" class="flex-1 bg-green-500 text-white py-2 rounded font-bold hover:bg-green-600 shadow">CONCLUIR</button>` : ''}
                                ${d.status === 'ready' ? `<div class="flex-1 text-center font-bold text-green-700 py-2"><i class="fas fa-check-circle"></i> ENTREGUE</div>` : ''}
                            </div>
                        </div>
                    `;
                });
            });
        }

        function updateStatus(id, status) {
            const data = { status: status };
            if (status === 'ready') data.completedAt = firebase.firestore.FieldValue.serverTimestamp();
            db.collection("orders").doc(id).update(data);
        }

        async function loadReports() {
            const today = new Date(); today.setHours(0,0,0,0);
            const snap = await db.collection("orders").where("timestamp", ">=", today).orderBy("timestamp", "desc").get();

            let totalSales = 0, totalOrders = 0, productCounts = {}, totalServiceTime = 0, completedOrdersCount = 0;
            const historyTable = document.getElementById('history-table');
            historyTable.innerHTML = "";

            snap.forEach(doc => {
                const d = doc.data();
                totalSales += d.total;
                totalOrders++;
                d.items.forEach(i => productCounts[i.name] = (productCounts[i.name] || 0) + i.qty);
                if (d.completedAt && d.timestamp) {
                    totalServiceTime += ((d.completedAt.toDate() - d.timestamp.toDate()) / 1000 / 60);
                    completedOrdersCount++;
                }
                const time = d.timestamp.toDate().toLocaleTimeString([],{hour:'2-digit', minute:'2-digit'});
                const shortHotel = d.hotel === 'Hit Hotel' ? 'HIT' : 'PORTO';
                historyTable.innerHTML += `<tr><td class="p-2 border-b">${time}</td><td class="p-2 border-b font-bold"><span class="text-xs text-gray-400 mr-1">${shortHotel}</span>Qto ${d.room}</td><td class="p-2 border-b text-green-600">${formatMoney(d.total)}</td></tr>`;
            });

            document.getElementById('stat-total').innerText = formatMoney(totalSales);
            document.getElementById('stat-count').innerText = `${totalOrders} pedidos hoje`;
            document.getElementById('stat-ticket').innerText = formatMoney(totalOrders ? (totalSales / totalOrders) : 0);
            document.getElementById('stat-time').innerText = `${completedOrdersCount ? Math.round(totalServiceTime / completedOrdersCount) : 0} min`;

            const sorted = Object.entries(productCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            document.getElementById('top-products').innerHTML = sorted.map(([k,v], i) => 
                `<div class="flex justify-between items-center"><div class="flex items-center gap-2"><span class="font-bold text-gray-400">#${i+1}</span> <span>${k}</span></div><span class="bg-blue-100 text-blue-800 font-bold px-2 py-0.5 rounded-full text-xs">${v}</span></div>`
            ).join('') || '<p class="text-gray-400 text-sm">Sem dados.</p>';
        }

        function formatMoney(v) { return v.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
    </script>
</body>
</html>
